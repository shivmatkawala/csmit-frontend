<div class="page-container">
    <div class="main-content">
        
        <!-- Header/Toolbar -->
        <header class="exam-header">
            <h1 class="font-bold text-lg text-gray-700">Exam Builder</h1>
            <div class="header-actions">
                <div class="total-marks-display">
                    Total Points: <span class="font-extrabold text-green-600">{{ totalMarks() }}</span>
                </div>
                <button (click)="goBack()" class="btn-action back-btn" title="Go Back">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>
            </div>
        </header>
        
        <!-- Main Form Container -->
        <form #examForm="ngForm" class="exam-form space-y-4" (ngSubmit)="saveExam(examForm)">

            <!-- 1. Exam Title/Description Card (Styled like Google Forms header) -->
            <div class="google-card title-card">
                <div class="title-section">
                    <input type="text" name="title" [(ngModel)]="exam.title" required placeholder="Untitled Exam" class="exam-title-input" #title="ngModel">
                    <div *ngIf="title.invalid && title.touched" class="title-error">Exam Title is required.</div>
                    
                    <textarea name="description" [(ngModel)]="exam.description" required placeholder="Exam description or instructions" class="exam-description-input" rows="2" #description="ngModel"></textarea>
                    <div *ngIf="description.invalid && description.touched" class="title-error">Description is required.</div>
                </div>

                <div class="duration-section">
                    <label>Duration (Minutes)</label>
                    <input type="number" name="duration" [(ngModel)]="exam.durationMinutes" required min="1" placeholder="60" class="duration-input" #duration="ngModel">
                    <div *ngIf="duration.invalid && duration.touched" class="title-error">Duration is required (Min 1).</div>
                </div>
            </div>

            <!-- 2. Question Cards (Repeatable Questions) -->
            <div class="question-list-wrapper">
                <div *ngFor="let question of exam.questions; let i = index" 
                    class="question-card"
                    [attr.draggable]="true"
                    (dragstart)="startDrag(i)"
                    (dragend)="endDrag()"
                    (dragover)="$event.preventDefault();"
                    (drop)="drop(i)"
                    [ngClass]="{'is-dragging': draggedIndex() === i, 'is-drag-target': draggedIndex() !== null && draggedIndex() !== i}"
                    >
                    <div class="drag-handle" title="Drag to reorder">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </div>

                    <div class="card-content">
                        <p class="question-number">Question #{{ i + 1 }}</p>
                        <p class="question-text">{{ question.text }}</p>

                        <div class="options-preview">
                            <div *ngFor="let option of question.options" class="option-preview-item">
                                <div class="option-indicator" [ngClass]="{'is-correct': option.id === question.correctOptionId}"></div>
                                <span [ngClass]="{'correct-preview': option.id === question.correctOptionId}">
                                    {{ getOptionLetter(option.id, question) }}. {{ option.text }} 
                                </span>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-200">
                            <span class="marks-display">{{ question.marks }} Points</span>
                            <div class="question-actions">
                                <button type="button" (click)="duplicateQuestion(question)" title="Duplicate Question" class="btn-icon duplicate-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
                                </button>
                                <button type="button" (click)="openQuestionEditor(question)" title="Edit Question" class="btn-icon edit-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                </button>
                                <button type="button" (click)="deleteQuestion(question.id)" title="Delete Question" class="btn-icon delete-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Floating Add Button -->
            <div class="floating-toolbar">
                <button type="button" (click)="addQuestionCard()" title="Add New Question" class="btn-floating-add">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
            </div>

            <!-- Submit Button (Sticky Bottom) -->
            <div class="final-actions-footer">
                <button type="submit" [disabled]="examForm.invalid || exam.questions.length === 0"
                        class="btn-save-exam">
                    Save and Publish Exam ({{ totalMarks() }} Points)
                </button>
                <p *ngIf="examForm.invalid || exam.questions.length === 0" class="validation-message">
                    *Please ensure all exam settings are complete and at least one question is added.
                </p>
            </div>
        </form>
    </div>
</div>

<!-- Modal Overlay for Question Editor -->
<div *ngIf="isEditorVisible()" class="modal-overlay" (click)="closeQuestionEditor()">
    <div class="google-card modal-card" (click)="$event.stopPropagation()">
        
        <header class="modal-header">
            <h3 class="text-xl font-bold text-indigo-700">{{ isEditMode() ? 'Edit Question' : 'Add New MCQ Question' }}</h3>
            <button (click)="closeQuestionEditor()" class="btn-close-modal" title="Close">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </header>

        <form #qForm="ngForm" (ngSubmit)="saveQuestion(qForm)" class="modal-form">
            
            <!-- Question Text and Marks Row -->
            <div class="form-group-row">
                <!-- Question Text -->
                <div class="form-group flex-grow">
                    <label for="qText">Question Text</label>
                    <textarea id="qText" name="qText" [(ngModel)]="currentQuestion.text" required rows="3" placeholder="Enter your question here..." class="form-input" #qText="ngModel"></textarea>
                    <div *ngIf="qText.invalid && qText.touched" class="error-message">Question text is required.</div>
                </div>

                <!-- Marks -->
                <div class="form-group marks-group">
                    <label for="qMarks">Points</label>
                    <input type="number" id="qMarks" name="qMarks" [(ngModel)]="currentQuestion.marks" required min="1" placeholder="2" class="form-input" #qMarks="ngModel">
                    <div *ngIf="qMarks.invalid && qMarks.touched" class="error-message">Points required (Min 1).</div>
                </div>
            </div>

            <!-- Options List -->
            <div class="options-container">
                <label class="options-label">Set Options (Min 2, Max 5)</label>
                
                <div *ngFor="let option of currentQuestion.options; let i = index" class="option-row">
                    <span class="option-letter">{{ getOptionLetter(option.id, currentQuestion) }}.</span>
                    <input type="text" [(ngModel)]="option.text" [name]="'optionText' + i" required placeholder="Option text" class="option-input" #optText="ngModel">
                    
                    <!-- Set Correct Answer Radio -->
                    <label class="correct-radio-label" title="Set as Correct Answer">
                        <input type="radio" [name]="'correctOption'" [value]="option.id" [(ngModel)]="currentQuestion.correctOptionId" required class="correct-radio" #correctOpt="ngModel">
                    </label>

                    <!-- Delete Option Button -->
                    <button type="button" (click)="removeOption(option.id)" [disabled]="currentQuestion.options.length <= 2"
                            class="btn-icon btn-remove-option" title="Remove Option">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>

                <!-- Correct Option Required Error -->
                <div *ngIf="qForm.submitted && !currentQuestion.correctOptionId" class="error-message pt-2">
                    *Please select the correct option.
                </div>
                
                <!-- Add Option Button -->
                <div class="pt-2">
                    <button type="button" (click)="addOption()" [disabled]="currentQuestion.options.length >= 5"
                            class="btn-add-option">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        <span>Add Option</span>
                    </button>
                </div>
            </div>

            <!-- Modal Actions -->
            <div class="modal-actions">
                <button type="button" (click)="closeQuestionEditor()" class="btn-modal-cancel">Cancel</button>
                <button type="submit" [disabled]="qForm.invalid" class="btn-modal-save">
                    {{ isEditMode() ? 'Update Question' : 'Add Question' }}
                </button>
            </div>
        </form>
    </div>
</div>
