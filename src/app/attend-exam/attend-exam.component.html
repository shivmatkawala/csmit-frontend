<div class="exam-wrapper" *ngIf="examId">
  
  <!-- Header (Only visible during exam, hidden on result screen) -->
  <header class="exam-header" *ngIf="!showResult">
    <div class="exam-title-section">
      <h1>{{ examName }}</h1>
      <p class="exam-info">Exam ID: {{ examId }} | Total Questions: {{ questions.length }}</p>
    </div>
    <div class="timer-section" [class.low-time]="timeLeftSeconds < 300">
      <i class="fas fa-clock"></i>
      <span class="timer-text">{{ formattedTimeLeft }}</span>
      <p class="timer-label">Time Remaining</p>
    </div>
  </header>

  <!-- UNIFIED RESULT SCREEN -->
  <div class="result-scroll-container" *ngIf="showResult && finalResult">
      <div class="full-page-result">
          
          <!-- Section 1: Score Summary -->
          <div class="result-summary-card">
              <i class="fas fa-award result-icon" [class.success]="finalResult.total_score > 0" [class.fail]="finalResult.total_score === 0"></i>
              <h1>Exam Completed!</h1>
              
              <div class="result-details">
                  <p class="score-label">Total Score</p>
                  <p class="score-value">
                     {{ (finalResult.total_score !== null && finalResult.total_score !== undefined ? finalResult.total_score : 0) | number:'1.2-2' }} 
                     <span class="max-score" *ngIf="finalResult.max_score">/ {{ finalResult.max_score }}</span>
                  </p>
                  <p class="status-message" [style.color]="finalResult.total_score > 0 ? '#2ecc71' : '#e74c4c'">
                     {{ finalResult.status_message || (finalResult.total_score > 0 ? 'Good effort!' : 'Needs improvement.') }}
                  </p>
              </div>
          </div>
          
          <!-- Section 2: Detailed Feedback (Automatically shown) -->
          <div class="detailed-feedback-section">
            <h2 class="feedback-title"><i class="fas fa-robot"></i> AI Detailed Feedback</h2>
            
            <div *ngIf="detailedAnswers.length === 0" class="loading-feedback">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Analyzing your answers... please wait.</p>
            </div>

            <div class="feedback-list" *ngIf="detailedAnswers.length > 0">
                <div *ngFor="let answer of detailedAnswers; let i = index" class="feedback-item">
                    <div class="question-header">
                        <h3>Q{{ i + 1 }}: {{ answer.question_type_id === 2 ? 'Descriptive' : (answer.question_type_id === 3 ? 'Coding' : 'MCQ') }}</h3>
                        <span class="score-pill" [class.full-marks]="answer.points_earned === answer.max_points" [class.zero-marks]="answer.points_earned === 0">
                            {{ answer.points_earned | number:'1.2-2' }} / {{ answer.max_points }}
                        </span>
                    </div>
                    
                    <div class="question-text-box">
                        <strong>Question:</strong> {{ answer.question_text }}
                    </div>
                    
                    <div class="answer-box">
                        <strong>Your Answer:</strong>
                        <pre>{{ answer.student_answer || 'No answer provided' }}</pre>
                    </div>
                    
                    <div class="ai-feedback-box" *ngIf="answer.ai_feedback">
                        <div class="feedback-header">
                            <i class="fas fa-lightbulb"></i> 
                            <strong>Feedback</strong>
                        </div>
                        <p>{{ answer.ai_feedback }}</p>
                    </div>
                </div>
            </div>
          </div>
          
          <div class="result-actions">
              <button class="btn-primary exit-btn" (click)="exitResultView()">
                  <i class="fas fa-arrow-left"></i> Return to Dashboard
              </button>
          </div>

      </div>
  </div>

  <!-- EXAM CONTENT (Hidden when Result is shown) -->
  <div class="exam-content" *ngIf="!showResult">
    
    <div class="question-panel">
      
      <div *ngIf="isLoading" class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading exam questions...</p>
      </div>
      
      <div *ngIf="isSubmitting" class="loading-state submitting-state">
        <i class="fas fa-upload fa-spin"></i>
        <h3>Submitting & Evaluating...</h3>
        <p>Please wait while our AI checks your answers.</p>
      </div>

      <div *ngIf="error && !isLoading && !isSubmitting" class="error-state">
        <i class="fas fa-exclamation-triangle"></i>
        <p>{{ error }}</p>
        <button class="btn-primary" (click)="examFinished.emit({status: 'submitted', message: 'Exam cancelled due to error.'})">Exit Exam</button>
      </div>

      <ng-container *ngIf="questions.length > 0 && !isLoading && !error && !isSubmitting">
        <div class="current-question">
          <div class="question-header">
            <h3>Question {{ currentQuestionIndex + 1 }}</h3>
            <span class="points">Points: {{ questions[currentQuestionIndex].points }}</span>
          </div>
          
          <div class="question-text">
            {{ questions[currentQuestionIndex].questiontext }}
          </div>
          
          <div class="answer-area">
            <ng-container [ngSwitch]="questions[currentQuestionIndex].questiontypeid">
              
              <ng-container *ngSwitchCase="1">
                <div class="mcq-options">
                  <div *ngFor="let option of questions[currentQuestionIndex].options" class="option-item">
                    <input 
                      type="radio" 
                      id="option_{{option.optionid}}" 
                      name="mcq_question_{{questions[currentQuestionIndex].questionid}}"
                      [value]="option.optionid"
                      [checked]="questions[currentQuestionIndex].studentAnswer === option.optionid"
                     (change)="onMcqSelect(option.optionid)"
                    />
                    <label for="option_{{option.optionid}}">{{ option.option_text }}</label>
                  </div>
                </div>
              </ng-container>

              <ng-container *ngSwitchCase="2">
                <textarea 
                  placeholder="Type your detailed answer here..."
                  rows="6"
                  [ngModel]="questions[currentQuestionIndex].studentAnswer"
                  (ngModelChange)="onTextChange($event)">
                </textarea>
                <p class="help-text">Please provide a descriptive answer (max 500 words).</p>
              </ng-container>

              <ng-container *ngSwitchCase="3">
                <textarea 
                  placeholder="Write your code solution here..."
                  rows="10"
                  [ngModel]="questions[currentQuestionIndex].studentAnswer"
                  (ngModelChange)="onTextChange($event)">
                </textarea>
                <p class="help-text">Paste your final, runnable code here.</p>
              </ng-container>

            </ng-container>
          </div>
        </div>

        <div class="question-nav-buttons">
          <button class="btn-secondary" (click)="previousQuestion()" [disabled]="currentQuestionIndex === 0">← Previous</button>
          <button class="btn-mark" (click)="markForReview()" [class.active]="questions[currentQuestionIndex].status === 'marked'">
            <i class="fas fa-flag"></i> {{ questions[currentQuestionIndex].status === 'marked' ? 'Unmark' : 'Mark for Review' }}
          </button>
          <button class="btn-primary" (click)="nextQuestion()" [disabled]="isLastQuestion">
            {{ isLastQuestion ? 'Review Exam' : 'Save & Next →' }}
          </button>
          <button *ngIf="isLastQuestion" class="btn-submit-final" (click)="submitExam()">Submit Exam</button>
        </div>

      </ng-container>
    </div>

    <div class="status-panel">
      <div class="exam-status-summary">
        <h4>Status Summary</h4>
        <div class="status-counts">
          <div class="count answered">Answered: {{ answeredCount }}</div>
          <div class="count marked">Marked: {{ markedCount }}</div>
          <div class="count unanswered">Unanswered: {{ unansweredCount }}</div>
        </div>
      </div>
      
      <div class="question-palette">
        <h4>Question Palette ({{ questions.length }} Qs)</h4>
        <div class="palette-grid">
          <button *ngFor="let q of questions; let i = index" 
                  [class.answered]="q.status === 'answered'"
                  [class.marked]="q.status === 'marked'"
                  [class.unanswered]="q.status === 'unanswered'"
                  [class.current]="i === currentQuestionIndex"
                  (click)="goToQuestion(i)">
            {{ i + 1 }}
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<div *ngIf="!examId" class="error-state full-page-error">
  <i class="fas fa-exclamation-circle"></i>
  <h1>Exam Not Found</h1>
  <p>Please select a valid exam from the dashboard.</p>
</div>