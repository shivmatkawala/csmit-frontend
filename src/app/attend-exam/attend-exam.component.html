<div class="exam-container" *ngIf="examId">

<!-- Security Warning Modal -->

<div class="security-overlay" *ngIf="showTabWarning">
<div class="warning-box">
<i class="fas fa-exclamation-triangle"></i>
<h2>Security Violation Detected!</h2>
<p>You attempted to switch browser tabs. This is a violation.</p>
<div class="warning-count">Warning {{ tabSwitchCount }} of {{ maxTabSwitches }}</div>
<p class="small" style="color: #64748b; font-size: 0.85rem; margin-bottom: 1.5rem;">The exam will be <strong>auto-submitted</strong> on the next tab switch.</p>
<button class="btn-warning-close" (click)="closeWarning()">I Understand</button>
</div>
</div>

<!-- Corporate Header -->

<header class="main-header" *ngIf="!showResult">
<div class="brand-info">
<div class="logo-placeholder"><i class="fas fa-shield-alt"></i></div>
<div class="exam-meta">
<h1 title="{{ examName }}">{{ examName }}</h1>
<span>ID: {{ examId }}</span>
</div>
</div>
<div class="timer-card" [class.danger-timer]="timeLeftSeconds < 120">
<div class="timer-icon"><i class="fas fa-stopwatch"></i></div>
<div class="timer-val">
<span class="label">Time Remaining</span>
<span class="value">{{ formattedTimeLeft }}</span>
</div>
</div>
</header>

<main class="exam-body" *ngIf="!showResult">
<!-- Left: Question Area -->
<section class="question-canvas">
<div *ngIf="isLoading" class="loader">
<i class="fas fa-circle-notch fa-spin"></i>
<p>Initializing Secure Session...</p>
</div>

  <div *ngIf="isSubmitting" class="loader">
    <i class="fas fa-cloud-upload-alt fa-spin"></i>
    <p>Syncing Final Responses...</p>
  </div>

  <div class="question-wrapper" *ngIf="!isLoading && !isSubmitting && questions.length > 0">
    <div class="q-header">
      <span class="q-index">Question {{ currentQuestionIndex + 1 }} of {{ questions.length }}</span>
      <span class="q-points">{{ questions[currentQuestionIndex].points }} Points</span>
    </div>

    <div class="q-content">
      <p class="q-text">{{ questions[currentQuestionIndex].questiontext }}</p>

      <div class="options-container" [ngSwitch]="questions[currentQuestionIndex].questiontypeid">
        <!-- MCQ -->
        <div *ngSwitchCase="1" class="mcq-grid">
          <label *ngFor="let opt of questions[currentQuestionIndex].options" 
                 class="option-card" 
                 [class.selected]="questions[currentQuestionIndex].studentAnswer === opt.optionid">
            <input type="radio" 
                   style="display:none"
                   name="q-{{currentQuestionIndex}}" 
                   [checked]="questions[currentQuestionIndex].studentAnswer === opt.optionid"
                   (change)="handleAnswer(opt.optionid)">
            <span class="radio-custom"></span>
            <span class="opt-text">{{ opt.option_text }}</span>
          </label>
        </div>

        <!-- Descriptive -->
        <div *ngSwitchCase="2" class="descriptive-box">
          <textarea placeholder="Type your detailed answer here..." 
                    rows="10" 
                    [ngModel]="questions[currentQuestionIndex].studentAnswer"
                    (ngModelChange)="handleAnswer($event)"></textarea>
        </div>

        <!-- Coding with Monaco Editor (No Run/Output) -->
        <div *ngSwitchCase="3" class="coding-interface">
          
          <!-- Editor Header / Controls (Run Button Removed) -->
          <div class="editor-header-bar">
             <div class="left-controls">
                <span class="file-icon"><i class="fas fa-file-code"></i></span>
                <select [(ngModel)]="selectedLanguage" (change)="changeLanguage()" class="lang-select">
                    <option *ngFor="let lang of languages" [value]="lang.value">
                        {{ lang.label }}
                    </option>
                </select>
             </div>
             <!-- Right controls empty now -->
             <div class="right-controls"></div>
          </div>

          <!-- Editor Area (Terminal Box Removed) -->
          <div class="editor-area-wrapper">
              
              <div *ngIf="!editorLoaded && !useFallbackEditor" class="editor-loader">
                  <i class="fas fa-circle-notch fa-spin"></i> Loading Editor...
              </div>

              <ngx-monaco-editor 
                  *ngIf="!useFallbackEditor"
                  class="monaco-component"
                  [options]="editorOptions" 
                  [ngModel]="questions[currentQuestionIndex].studentAnswer"
                  (ngModelChange)="handleAnswer($event)"
                  (onInit)="onEditorInit($event)">
              </ngx-monaco-editor>

              <textarea 
                  *ngIf="useFallbackEditor"
                  class="fallback-textarea"
                  placeholder="// Write your code here."
                  [ngModel]="questions[currentQuestionIndex].studentAnswer"
                  (ngModelChange)="handleAnswer($event)"></textarea>
          </div>

        </div>
      </div>
    </div>

    <div class="q-footer">
      <button class="btn-nav" (click)="previousQuestion()" [disabled]="currentQuestionIndex === 0">
        <i class="fas fa-chevron-left"></i> Previous
      </button>
      <div class="spacer"></div>
      <button class="btn-nav primary" (click)="nextQuestion()" *ngIf="currentQuestionIndex < questions.length - 1">
        Save & Next <i class="fas fa-chevron-right"></i>
      </button>
      <button class="btn-nav submit" (click)="autoSubmitExam('submitted')" *ngIf="currentQuestionIndex === questions.length - 1">
        Finish Test <i class="fas fa-check-circle"></i>
      </button>
    </div>
  </div>
</section>

<!-- Right: Sidebar Palette -->
<aside class="exam-sidebar">
  <div class="sidebar-card">
    <h3>Question Palette</h3>
    <div class="palette-grid">
      <button *ngFor="let q of questions; let i = index" 
              [class.active]="i === currentQuestionIndex"
              [class.answered]="q.status === 'answered'"
              (click)="goToQuestion(i)">
        {{ i + 1 }}
      </button>
    </div>
  </div>

  <div class="sidebar-card status-summary">
    <div class="stat-item">
      <div class="lbl-group">
        <span class="dot answered"></span>
        <span class="lbl">Answered</span>
      </div>
      <span class="val">{{ answeredCount }}</span>
    </div>
    <div class="stat-item">
      <div class="lbl-group">
        <span class="dot unanswered"></span>
        <span class="lbl">Not Answered</span>
      </div>
      <span class="val">{{ unansweredCount }}</span>
    </div>
  </div>
</aside>


</main>

<!-- RESULT SCREEN -->

<div class="result-view" *ngIf="showResult && finalResult">
<div class="result-container">
<div class="result-card">
<div class="success-icon" style="font-size: 4rem; color: #10b981; margin-bottom: 1rem;">
<i class="fas fa-check-circle"></i>
</div>
<h2 style="color: #0f172a; margin-bottom: 0.5rem;">Test Submitted!</h2>
<p style="color: #64748b; margin-bottom: 2rem;">Your responses have been evaluated.</p>

    <div class="score-display" style="background: #f8fafc; padding: 2rem; border-radius: 16px; margin-bottom: 2rem;">
      <span class="score" style="font-size: 3rem; font-weight: 800; color: #3b82f6; display: block;">
          {{ finalResult.total_score | number:'1.0-1' }}
      </span>
      <span class="total" style="color: #64748b; font-weight: 600;">out of {{ finalResult.max_score }}</span>
    </div>
    
    <p class="feedback" style="font-style: italic; color: #475569; margin-bottom: 2rem;">
      "{{ finalResult.status_message }}"
    </p>
  </div>

  <div class="analysis-section" *ngIf="detailedAnswers.length > 0">
    <h3><i class="fas fa-robot"></i> Detailed AI Analysis</h3>
    <div class="analysis-card" *ngFor="let ans of detailedAnswers; let i = index">
      <div class="ans-header">
        <span class="q-num">Question {{ i + 1 }}</span>
        <span class="score-badge" 
              [class.full-marks]="ans.points_earned === ans.max_points" 
              [class.partial]="ans.points_earned > 0 && ans.points_earned < ans.max_points" 
              [class.zero]="ans.points_earned === 0">
          Score: {{ ans.points_earned }} / {{ ans.max_points }}
        </span>
      </div>
      <div class="ans-body">
        <p class="q-text-result">{{ ans.question_text }}</p>
        <div class="student-response">
          <span class="label">Your Response:</span>
          <div class="response-box" [ngClass]="{'code-response': ans.question_type_id === 3}">
            {{ ans.student_answer || 'No Answer Provided' }}
          </div>
        </div>
        <div class="ai-feedback-box">
          <div class="feedback-header"><i class="fas fa-brain"></i> AI Explanation</div>
          <p>{{ ans.ai_feedback || 'AI is generating feedback...' }}</p>
        </div>
      </div>
    </div>
  </div>

  <button class="btn-nav primary" style="width: 100%; justify-content: center; padding: 1rem; margin-top: 1rem;" 
          (click)="examFinished.emit({status:'submitted', message:'Done'})">
    Return to Dashboard
  </button>
</div>


</div>
</div>