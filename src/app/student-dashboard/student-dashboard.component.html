<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<body>
<!-- Main container for the dashboard -->
<div class="container">
<header>
<div class="logo-search">
<div class="logo">
<!-- Logo Image added here, replacing CODE HUB text -->
<img src="assets/logo.jpg" alt="Institute Logo" class="institute-logo">
</div>
<div class="search-wrapper">
<!-- Search for Courses/Assignments -->
<input type="search" placeholder="Search Courses, Assignments..." [formControl]="searchControl" />
<i class="fas fa-search"></i>
</div>
</div>
<div class="header-right">
<!-- 'Attend Exam' button: Hides when activePage is 'attend-exam' (User's request) -->
<button class="btn-request" (click)="openExamModal()" style="background-color: #F59E0B;"
    *ngIf="activePage !== 'attend-exam'">
    <i class="fas fa-edit"></i> Attend Exam
</button>

<!-- 'Download Resume' button as the secondary button -->
<button class="btn-request" (click)="downloadResume()">
<i class="fas fa-file-download"></i> Download Resume
</button>

    <!-- Profile Picture or Initial Text. Click to go to Profile Setting. -->
    <div class="user-avatar" title="{{ studentName }}" (click)="setActivePage('profile-setting')">
      <ng-container *ngIf="!profileImagePlaceholder && profileImageUrl">
        <!-- If image URL exists, image will display here -->
        <img [src]="profileImageUrl" alt="Student Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
      </ng-container>
      <ng-container *ngIf="profileImagePlaceholder || !profileImageUrl">
        <!-- If no image URL, the name initial will display -->
        <span class="initial-text">{{ profileInitial }}</span>
      </ng-container>
    </div>
  </div>
</header>

<!-- Sidebar Navigation (Left) -->
<aside class="sidebar">
  <div>
    <nav class="sidebar-nav">
      <!-- Links are managed by activePage property -->
      <a [class.active]="activePage === 'dashboard'" (click)="setActivePage('dashboard')"><i class="fas fa-chart-line"></i>Dashboard</a>
      <a [class.active]="activePage === 'courses'" (click)="setActivePage('courses')"><i class="fas fa-book"></i>Courses</a>
      <a [class.active]="activePage === 'assignments'" (click)="setActivePage('assignments')"><i class="fas fa-tasks"></i>Assignments</a>
      <a [class.active]="activePage === 'career'" (click)="setActivePage('career')"><i class="fas fa-briefcase"></i>Career</a>
    </nav>
  </div>
  <div class="sidebar-bottom">
    <div class="toggle-switch" id="toggleSwitch" [class.active]="notificationsEnabled" (click)="notificationsEnabled = !notificationsEnabled" title="Toggle Notifications">
      <span></span>
    </div>
    <!-- Settings icon is linked to setActivePage('profile-setting') -->
    <a [class.active]="activePage === 'profile-setting'" (click)="setActivePage('profile-setting')" title="Profile Settings"><i class="fas fa-cog"></i></a>
  </div>
</aside>

<!-- Right Schedule Card (Calendar and Schedule) -->
<section class="right-schedule-card" *ngIf="activePage !== 'attend-exam'">
  <div class="current-time-display">
    <p class="current-time-text">Current Time: {{ currentTime }}</p>
  </div>
  <div class="right-schedule-header">
    <h3>My Academic Schedule</h3>
    <button aria-label="Open Calendar"><i class="fas fa-calendar-alt"></i></button>
  </div>

  <!-- Calendar Controls (Monthly View) -->
  <div class="calendar-controls">
    <button aria-label="Previous Month" (click)="navigateCalendar(-1)">&lt;</button>
    <p>{{ selectedMonthYear }}</p>
    <button aria-label="Next Month" (click)="navigateCalendar(1)">&gt;</button>
  </div>

  <!-- Calendar Grid -->
  <div class="calendar-weekdays">
    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
  </div>
  <div class="calendar-days">
    <!-- Day cell -->
    <div *ngFor="let day of calendarDays"
      [class.inactive]="day.disabled"
      [class.active]="day.selected"
      (click)="!day.disabled && onDateSelect(day.fullDate)"
      [class.selected-for-leave]="selectedScheduleDate && day.fullDate && day.fullDate.toDateString() === selectedScheduleDate.toDateString()"
      [title]="day.fullDate ? (day.fullDate | date:'fullDate') : ''">
      {{ day.date }}
    </div>
  </div>

  <!-- Schedule List -->
  <div class="schedule-list">
    <h5>Schedule for {{ selectedScheduleDate | date:'dd MMM yyyy' }}</h5>
    <div *ngIf="scheduleDetails.length === 0" class="no-schedule-message">
        Select a date to see the schedule, or view your main deadlines below.
    </div>
    <div *ngFor="let item of scheduleDetails" class="schedule-section">
      <div class="schedule-item" [ngClass]="item.type + '-item'">
        <div class="date">
          {{ item.dayOfWeekShort }} <br> {{ item.dayOfMonth }}
        </div>
        <p class="desc">{{ item.desc }}</p>
        <button *ngIf="item.joinButton" class="join-button">Join Class</button>
      </div>
    </div>

    <!-- Next Deadlines (Summary at bottom of Schedule Card) -->
    <div class="schedule-section" style="margin-top: 20px; border-top: 1px solid #CBD5E1; padding-top: 15px;">
      <h5>Upcoming Deadlines Summary</h5>
      <!-- FIX: deadline-item, schedule-item के समान स्टाइल का उपयोग करने के लिए अपडेट किया गया -->
      <div *ngFor="let deadline of nextDeadlines" class="schedule-item deadline-item">
        <div class="date">
          {{ deadline.date | date:'EEE' | uppercase }} <br> {{ deadline.date | date:'dd' }}
        </div>
        <p class="desc">
          {{ deadline.desc }} <br>
          <span style="font-style: italic; color: #4338CA;">Due: {{ deadline.date | date:'mediumDate' }}</span>
        </p>
      </div>
    </div>
  </div>
</section>

<!-- Main Content Area -->
<main class="main-content" [class.full-width]="activePage === 'attend-exam'">
  <!-- 1. DASHBOARD CONTENT (Default) -->
  <ng-container *ngIf="activePage === 'dashboard'">
    
    <!-- 1. Good Morning Card (Greeting + Clock) -> Trainer's first card position (.trainer-info-card) -->
    <section class="trainer-info-card">
        <img [src]="profileImageUrl" 
             alt="{{ studentName }}" 
             class="profile-img" 
             title="{{ studentName }}"
             *ngIf="!profileImagePlaceholder">
        <div class="profile-img" style="background-color: #4338CA; border-color: #F43F5E;" *ngIf="profileImagePlaceholder">
            <span style="font-size: 32px; font-weight: 700; color: white;">{{ profileInitial }}</span>
        </div>

        <!-- studentName is updated from API service storage -->
        <h2>{{ studentName }}</h2> 
        <p class="role">{{ greeting }}</p>
        
        <!-- Replaced batch-details with Today's Date/Day -->
        <div class="batch-details" style="border-top: none; padding-top: 0;">
            <p style="color: #4338CA; margin-bottom: 4px;">{{ currentDayOfWeek }}, {{ currentDay }} {{ currentMonth }}</p>
            <span style="font-size: 12px; font-weight: 500; color: #94A3B8;">Realtime Progress and Study Goals</span>
        </div>

        <div class="time-row">
            <i class="fas fa-clock"></i>
            <span>{{ currentTime | date:'hh:mm:ss a' }}</span>
        </div>

        <!-- Button to encourage action -->
        <button (click)="openAssignmentModal()" class="btn-request" style="background-color: #10B981; margin-top: 10px; font-size: 14px;">
            <i class="fas fa-edit"></i> Quick Submit Assignment
        </button>
    </section>

    <!-- 2. Quick Access Cards (4 Cards - Metrics) -> Trainer's second card position (.stats-cards-container) -->
    <section class="stats-cards-container">
        <!-- FIX: Using Trainer's Stat Card Structure (.stat-card) -->
        <div *ngFor="let card of quickAccessCards; let i = index" 
            class="stat-card" 
            [ngClass]="card.colorClass"
            (click)="handleQuickCardClick(card.route)"
            [title]="card.value">
          
          <p class="title">{{ card.title }}</p>
          <p class="value">{{ card.value }}</p>
          <div class="footer-info">
            <span style="font-size: 11px;">{{ card.subText }}</span>
             <!-- Icon based on card type -->
            <i [class]="card.icon" [ngStyle]="{'color': i === 0 ? '#4338CA' : i === 1 ? '#F59E0B' : i === 2 ? '#10B981' : '#F43F5E'}"></i>
          </div>
        </div>
    </section>

    <!-- 3. Study Time Tracking Card - (REMOVED BY USER REQUEST) -->
    <!-- 4. Top 3 Courses/Progress Card - (REMOVED BY USER REQUEST) -->
    <!-- 5. Latest Resources/Video Card - (REMOVED BY USER REQUEST) -->
  </ng-container>

  <!-- 2. ATTEND EXAM CONTENT (NEW PAGE) -->
  <ng-container *ngIf="activePage === 'attend-exam' && examToAttend">
      <!-- Assuming <app-attend-exam> component exists and handles the exam logic -->
      <app-attend-exam
          [examId]="examToAttend.examId"
          [examName]="examToAttend.examName"
          [durationMinutes]="examToAttend.durationMinutes"
          (examFinished)="onExamFinished($event)">
      </app-attend-exam>
  </ng-container>


  <!-- 3. PROFILE SETTING CONTENT -->
  <ng-container *ngIf="activePage === 'profile-setting'">
    <div class="profile-setting-wrapper">
      <app-profile-setting [profileData]="studentProfileData" (goBack)="setActivePage('dashboard')"></app-profile-setting>
    </div>
  </ng-container>

  <!-- 4. OTHER PAGES CONTENT (Placeholder) -->
  <ng-container *ngIf="activePage !== 'dashboard' && activePage !== 'profile-setting' && activePage !== 'attend-exam'">
    <div class="other-page-content">
      <h1>{{ activePage | uppercase }} Page Content (Not Implemented)</h1>
      <p>Please navigate back to the dashboard to see the main content.</p>
    </div>
  </ng-container>
</main>

<!-- Assignment Submission Modal -->
<div *ngIf="showAssignmentModal" class="modal-overlay">
<!-- FIX: Assignment Modal Class changed to match Trainer's Modal class name -->
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Submit Assignment</h3>
      <button class="close-button" (click)="closeAssignmentModal()">&times;</button>
    </div>
    <div class="form-group">
      <label for="assignmentTitle">Assignment Title:</label>
      <select id="assignmentTitle" [formControl]="assignmentTitleControl" required>
        <option value="">Select Assignment</option>
        <option value="CS501 - Final Project">CS501 - Final Project</option>
        <option value="IT402 - Week 8 Quiz">IT402 - Week 8 Quiz</option>
        <option value="IT303 - DB Schema">IT303 - DB Schema</option>
      </select>
    </div>
    <div class="form-group">
      <label for="submissionDetails">Submission Details/Link (Optional):</label>
      <textarea id="submissionDetails" [formControl]="assignmentDetailsControl" rows="4"></textarea>
    </div>
    <div class="form-group file-upload">
      <label>Upload File:</label>
      <input type="file" />
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cancel" (click)="closeAssignmentModal()">Cancel</button>
      <button type="submit" class="btn-submit" (click)="submitAssignment()" [disabled]="assignmentTitleControl.invalid">Submit Work</button>
    </div>
  </div>
</div>

<!-- ======================================================= -->
<!-- EXAM ATTENDANCE MODAL (UPDATED FOR CATEGORIZATION AND SIZE) -->
<!-- ======================================================= -->
<div *ngIf="showExamModal" class="modal-overlay">
    <!-- FIX: max-width और height/max-height को 50% पर सेट किया गया है -->
    <div class="modal-content" style="max-width: 50vw; width: 50vw; max-height: 50vh; height: 50vh; overflow: hidden; display: flex; flex-direction: column;">
        <div class="modal-header" style="flex-shrink: 0;">
            <h3>Filter & Select Exam</h3>
            <button class="close-button" (click)="closeExamModal()">&times;</button>
        </div>
        <div class="modal-body" style="flex-grow: 1; overflow-y: auto; padding: 0 25px 20px 25px;">
            <!-- Loading State -->
            <div *ngIf="isLoadingExams && allExams.length === 0" style="text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #4338CA;"></i>
                <p style="margin-top: 10px; color: #64748B;">Loading available Exams...</p>
            </div>
            
            <!-- Filter Section (Course and Batch) -->
            <div style="padding: 10px; background-color: #eef2ff; border-radius: 8px; margin-bottom: 20px; border: 1px solid #c0c7e2;">
                <h4 style="font-size: 16px; margin-top: 0; color: #4338CA; border-bottom: 1px solid #d4dcf5; padding-bottom: 8px; margin-bottom: 12px;">Filter Exams by Course/Batch</h4>
                
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <!-- Course Filter -->
                    <div>
                        <label for="filterCourseId" style="font-weight: 600;">Your Assigned Course</label>
                        <select 
                            id="filterCourseId" 
                            [(ngModel)]="selectedCourseId" 
                            (change)="applyExamFilter()" 
                            class="form-control"
                        >
                            <option [ngValue]="null" disabled>Select Course</option>
                            <option *ngFor="let course of studentCoursesForFilter" [ngValue]="course.course_id">
                                {{ course.course_name }} (ID: {{ course.course_id }})
                            </option>
                        </select>
                    </div>

                    <!-- Batch Filter -->
                    <div>
                        <label for="filterBatchId" style="font-weight: 600;">Your Assigned Batch</label>
                        <select 
                            id="filterBatchId" 
                            [(ngModel)]="selectedBatchId" 
                            (change)="applyExamFilter()" 
                            [disabled]="!selectedCourseId || studentBatchesForFilter.length === 0"
                            class="form-control"
                        >
                            <option [ngValue]="null" disabled>Select Batch</option>
                            <option *ngFor="let batch of studentBatchesForFilter" [ngValue]="batch.batchid">
                                {{ batch.batch_name }} (ID: {{ batch.batchid }})
                            </option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- No Exams Available State -->
            <div *ngIf="!isLoadingExams && activeExams.length === 0 && selectedCourseId !== null && selectedBatchId !== null" 
                style="text-align: center; padding: 20px; border: 1px dashed #F43F5E; border-radius: 8px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 20px; color: #F43F5E;"></i>
                <p style="margin-top: 10px; font-weight: 600; color: #334155;">
                    Sorry! No Exams found for the selected Course and Batch.
                </p>
                <p style="font-size: 12px; color: #64748B; margin-top: 5px;">Please check your selection or contact the administrator.</p>
            </div>
            
            <!-- NEW SECTION: Categorized Exam Lists -->
            <div *ngIf="!isLoadingExams && activeExams.length > 0" class="exam-categories-wrapper">
                
                <!-- UPCOMING/ACTIVE EXAMS (Selectable) -->
                <h4 style="font-size: 18px; color: #10B981; margin-top: 25px; border-bottom: 1px solid #10B981; padding-bottom: 5px;">
                    <i class="fas fa-calendar-check" style="margin-right: 8px;"></i> Upcoming/Active Exams ({{ upcomingExams.length }})
                </h4>
                <div *ngIf="upcomingExams.length > 0; else noUpcomingExams">
                    <div class="form-group">
                        <label for="selectExamUpcoming" style="font-weight: 600;">Select an Exam to Start:</label>
                        <select id="selectExamUpcoming" [(ngModel)]="selectedExamId" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #10B981; border-radius: 4px;">
                            <option [ngValue]="null">--- Select Exam to Start ---</option>
                            <option *ngFor="let exam of upcomingExams" [ngValue]="exam.examId">
                                {{ exam.examName }} (Starts: {{ exam.start_datetime | date:'short' }} | {{ exam.durationMinutes }} Min)
                            </option>
                        </select>
                    </div>
                </div>
                <ng-template #noUpcomingExams>
                    <p style="text-align: center; padding: 10px; border: 1px dashed #10B981; border-radius: 6px; color: #10B981; background-color: #f6fff9;">No Upcoming Exams found for this selection.</p>
                </ng-template>

                <!-- ATTENDED EXAMS (Read-only/Placeholder) -->
                <h4 style="font-size: 18px; color: #4338CA; margin-top: 25px; border-bottom: 1px solid #4338CA; padding-bottom: 5px;">
                    <i class="fas fa-check-circle" style="margin-right: 8px;"></i> Attended Exams ({{ attendedExams.length }})
                </h4>
                <p *ngIf="attendedExams.length === 0" style="text-align: center; padding: 10px; border: 1px dashed #4338CA; border-radius: 6px; color: #4338CA; background-color: #f5f6ff; font-size: 14px;">
                    No Attended Exams found. (Requires attempt history API from server)
                </p>
                <div *ngIf="attendedExams.length > 0">
                    <!-- Placeholder list for attended exams -->
                    <ul style="list-style: none; padding: 0;">
                        <li *ngFor="let exam of attendedExams" style="margin-bottom: 8px; padding: 8px; background-color: #f0f4ff; border-radius: 4px; font-size: 14px; color: #4338CA;">
                            {{ exam.examName }} - View Result (Future Feature)
                        </li>
                    </ul>
                </div>


                <!-- EXPIRED EXAMS (Read-only) -->
                <h4 style="font-size: 18px; color: #F43F5E; margin-top: 25px; border-bottom: 1px solid #F43F5E; padding-bottom: 5px;">
                    <i class="fas fa-times-circle" style="margin-right: 8px;"></i> Expired Exams ({{ expiredExams.length }})
                </h4>
                <div *ngIf="expiredExams.length > 0; else noExpiredExams">
                     <ul style="list-style: none; padding: 0;">
                        <li *ngFor="let exam of expiredExams" style="margin-bottom: 8px; padding: 8px; background-color: #fef2f2; border-radius: 4px; font-size: 14px; color: #F43F5E;">
                            {{ exam.examName }} - Ended on: {{ exam.end_datetime | date:'short' }}
                        </li>
                    </ul>
                </div>
                <ng-template #noExpiredExams>
                    <p style="text-align: center; padding: 10px; border: 1px dashed #F43F5E; border-radius: 6px; color: #F43F5E; background-color: #fff8f8;">No Expired Exams found for this selection.</p>
                </ng-template>

            </div>
        
            <!-- Exam Details (Conditional Display, moved outside the categorized sections) -->
            <div *ngIf="selectedExam as currentExam" style="background-color: #f0f4ff; border: 1px solid #4338CA; border-radius: 8px; padding: 15px; margin-top: 20px;">
                <ng-container>
                    <h4 style="font-size: 16px; margin-top: 0; color: #4338CA;">Exam Details</h4>
                    <p style="margin: 5px 0; font-size: 14px;"><i class="fas fa-book" style="margin-right: 8px; color: #4338CA;"></i> <strong>Subject:</strong> {{ currentExam.subject.subjectname || ('ID: ' + currentExam.subjectid) }}</p>
                    <p style="margin: 5px 0; font-size: 14px;"><i class="fas fa-clock" style="margin-right: 8px; color: #4338CA;"></i> <strong>Duration:</strong> {{ currentExam.durationMinutes }} Minutes</p>
                    <p style="margin: 5px 0; font-size: 14px;"><i class="fas fa-question-circle" style="margin-right: 8px; color: #4338CA;"></i> <strong>Total Questions:</strong> {{ currentExam.totalQuestions }}</p>
                    <p style="margin: 5px 0; font-size: 14px;"><i class="fas fa-users" style="margin-right: 8px; color: #4338CA;"></i> <strong>Target:</strong> Batch ID {{ currentExam.batchid }}, Course ID {{ currentExam.courseid }}</p>
                    
                    <div style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #c0c7e2;">
                        <p style="margin: 5px 0; font-size: 14px; color: #22C55E;"><i class="fas fa-calendar-alt" style="margin-right: 8px;"></i> <strong>Start Time:</strong> {{ currentExam.start_datetime | date:'medium' }}</p>
                        <p style="margin: 5px 0; font-size: 14px; color: #EF4444;"><i class="fas fa-calendar-times" style="margin-right: 8px;"></i> <strong>End Time:</strong> {{ currentExam.end_datetime | date:'medium' }}</p>
                    </div>
                    
                    <p style="margin-top: 15px; font-size: 12px; color: #F43F5E;">**Warning:** Once the exam starts, you cannot stop or pause it.</p>
                </ng-container>
            </div>
        </div>
        <div class="modal-footer" style="flex-shrink: 0; margin-top: 0; padding-top: 20px;">
            <button class="btn-cancel" (click)="closeExamModal()">Cancel</button>
            <button class="btn-submit" 
                    (click)="startExam()" 
                    [disabled]="!selectedExamId || isLoadingExams || upcomingExams.length === 0"
                    style="background-color: #10B981;">
                <i class="fas fa-play" style="margin-right: 5px;"></i> Start Exam
            </button>
        </div>
    </div>
</div>
<div *ngIf="message" [class]="'message-box ' + messageType">
  {{ message }}
  <button class="close-message" (click)="clearMessage()">&times;</button>
</div>
</div>
</body>