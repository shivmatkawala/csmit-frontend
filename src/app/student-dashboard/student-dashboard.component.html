<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<body>
<!-- Main container for the dashboard -->
<div class="container">
<header>
<div class="logo-search">
<div class="logo">
<!-- Logo Image added here, replacing CODE HUB text -->
<img src="assets/logo.jpg" alt="Institute Logo" class="institute-logo">
</div>
<div class="search-wrapper">
<!-- Search for Courses/Assignments -->
<input type="search" placeholder="Search Courses, Assignments..." [formControl]="searchControl" />
<i class="fas fa-search"></i>
</div>
</div>
<div class="header-right">
<!-- 'Attend Exam' button added here -->
<button class="btn-request" (click)="openExamModal()" style="background-color: #F59E0B;">
    <i class="fas fa-edit"></i> Attend Exam
</button>

<!-- 'Download Resume' button as the secondary button -->
<button class="btn-request" (click)="downloadResume()">
<i class="fas fa-file-download"></i> Download Resume
</button>

    <!-- Profile Picture or Initial Text. Click to go to Profile Setting. -->
    <div class="user-avatar" title="{{ studentName }}" (click)="setActivePage('profile-setting')">
      <ng-container *ngIf="!profileImagePlaceholder && profileImageUrl">
        <!-- If image URL exists, image will display here -->
        <img [src]="profileImageUrl" alt="Student Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
      </ng-container>
      <ng-container *ngIf="profileImagePlaceholder || !profileImageUrl">
        <!-- If no image URL, the name initial will display -->
        <span class="initial-text">{{ profileInitial }}</span>
      </ng-container>
    </div>
  </div>
</header>

<!-- Sidebar Navigation (Left) -->
<aside class="sidebar">
  <div>
    <nav class="sidebar-nav">
      <!-- Links are managed by activePage property -->
      <a [class.active]="activePage === 'dashboard'" (click)="setActivePage('dashboard')"><i class="fas fa-chart-line"></i>Dashboard</a>
      <a [class.active]="activePage === 'courses'" (click)="setActivePage('courses')"><i class="fas fa-book"></i>Courses</a>
      <a [class.active]="activePage === 'assignments'" (click)="setActivePage('assignments')"><i class="fas fa-tasks"></i>Assignments</a>
      <a [class.active]="activePage === 'career'" (click)="setActivePage('career')"><i class="fas fa-briefcase"></i>Career</a>
    </nav>
  </div>
  <div class="sidebar-bottom">
    <div class="toggle-switch" id="toggleSwitch" [class.active]="notificationsEnabled" (click)="notificationsEnabled = !notificationsEnabled" title="Toggle Notifications">
      <span></span>
    </div>
    <!-- Settings icon is linked to setActivePage('profile-setting') -->
    <a [class.active]="activePage === 'profile-setting'" (click)="setActivePage('profile-setting')" title="Profile Settings"><i class="fas fa-cog"></i></a>
  </div>
</aside>

<!-- Right Schedule Card (Calendar and Schedule) -->
<!-- FIX: जब activePage 'attend-exam' हो तो Schedule Card को छिपा दें -->
<section class="right-schedule-card" *ngIf="activePage !== 'attend-exam'">
  <div class="current-time-display">
    <p class="current-time-text">Current Time: {{ currentTime }}</p>
  </div>
  <div class="right-schedule-header">
    <h3>My Academic Schedule</h3>
    <button aria-label="Open Calendar"><i class="fas fa-calendar-alt"></i></button>
  </div>

  <!-- Calendar Controls (Monthly View) -->
  <div class="calendar-controls">
    <button aria-label="Previous Month" (click)="navigateCalendar(-1)">&lt;</button>
    <p>{{ selectedMonthYear }}</p>
    <button aria-label="Next Month" (click)="navigateCalendar(1)">&gt;</button>
  </div>

  <!-- Calendar Grid -->
  <div class="calendar-weekdays">
    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
  </div>
  <div class="calendar-days">
    <!-- Day cell -->
    <div *ngFor="let day of calendarDays"
      [class.inactive]="day.disabled"
      [class.active]="day.selected"
      (click)="!day.disabled && onDateSelect(day.fullDate)"
      [class.selected-for-leave]="selectedScheduleDate && day.fullDate && day.fullDate.toDateString() === selectedScheduleDate.toDateString()"
      [title]="day.fullDate ? (day.fullDate | date:'fullDate') : ''">
      {{ day.date }}
    </div>
  </div>

  <!-- Schedule List -->
  <div class="schedule-list">
    <h5>Schedule for {{ selectedScheduleDate | date:'dd MMM yyyy' }}</h5>
    <div *ngIf="scheduleDetails.length === 0" class="no-schedule-message">
        Select a date to see the schedule, or view your main deadlines below.
    </div>
    <div *ngFor="let item of scheduleDetails" class="schedule-section">
      <div class="schedule-item" [ngClass]="item.type + '-item'">
        <div class="date">
          {{ item.dayOfWeekShort }} <br> {{ item.dayOfMonth }}
        </div>
        <p class="desc">{{ item.desc }}</p>
        <button *ngIf="item.joinButton" class="join-button">Join Class</button>
      </div>
    </div>

    <!-- Next Deadlines (Summary at bottom of Schedule Card) -->
    <div class="schedule-section" style="margin-top: 20px; border-top: 1px solid #CBD5E1; padding-top: 15px;">
      <h5>Upcoming Deadlines Summary</h5>
      <div *ngFor="let deadline of nextDeadlines" class="schedule-item deadline-item">
        <div class="date">
          {{ deadline.date | date:'EEE' | uppercase }} <br> {{ deadline.date | date:'dd' }}
        </div>
        <p class="desc">
          {{ deadline.desc }} <br>
          <span style="font-style: italic; color: #4338CA;">Due: {{ deadline.date | date:'mediumDate' }}</span>
        </p>
      </div>
    </div>
  </div>
</section>

<!-- Main Content Area -->
<!-- FIX: Layout को 'attend-exam' के लिए एडजस्ट करें -->
<main class="main-content" [class.full-width]="activePage === 'attend-exam'">
  <!-- 1. DASHBOARD CONTENT (Default) -->
  <ng-container *ngIf="activePage === 'dashboard'">
    <!-- 1. Good Morning Card (Greeting + Clock) -->
    <section class="good-morning-card">
      <p class="small-text">{{ greeting }}</p>
      <!-- studentName is updated from API service storage -->
      <h2>{{ studentName }}</h2> 
      <div class="time-row">
        <i class="fas fa-clock"></i>
        <span>{{ currentTime }}</span>
      </div>
      <p class="small-text" style="margin-bottom: 16px;">Realtime Progress and Study Goals</p>
      <p class="small-text" style="margin-bottom: 24px;">Today: {{ currentDayOfWeek }}, {{ currentDay }} {{ currentMonth }} {{ todayDate | date:'yyyy' }}</p>
      <!-- Button to encourage action -->
      <button (click)="openAssignmentModal()">Quick Submit Assignment</button>
    </section>

    <!-- 2. Feature/Utility Cards (4 Cards - Metrics) -->
    <section class="metrics-cards-container">
        <div *ngFor="let card of featureCards; let i = index" 
            class="feature-card" 
            [attr.data-color]="card.color"
            (click)="openFeature(card.route)">

          <div class="card-content">
            <div class="card-top-row">
              <div class="card-icon" [style.color]="card.color">
                <i [class]="card.icon"></i>
              </div>
              <p class="title">{{ card.label }}</p>
            </div>
            <div class="card-main-data">
              <!-- Real-time data points based on the feature -->
              <ng-container [ngSwitch]="card.label">
                <span *ngSwitchCase="'Project Status'" class="value large-value" [style.color]="card.color">{{ card.value.status }}</span>
                <div *ngSwitchCase="'Skill Score'" class="value large-value" [style.color]="card.color">
                  {{ card.value.score }} <span class="small-text-unit">/ 100</span>
                </div>
                
                <div *ngSwitchCase="'Recording Classes'" class="value large-value" [style.color]="card.color">
                  {{ card.value.watched }}<span class="small-text-unit">/{{ card.value.total }}</span>
                </div>
                
                <div *ngSwitchCase="'Daily Coding Streak'" class="value large-value" [style.color]="card.color">
                  {{ card.value.streak }} <span class="small-text-unit">Days</span>
                </div>
                <div *ngSwitchCase="'Current Focus'" class="value" [style.color]="card.color">
                  <span class="focus-title">{{ card.value.course }}</span>
                  <div class="focus-progress-bar">
                    <div class="fill" [style.width.%]="card.value.progress" [style.background-color]="card.color"></div>
                  </div>
                </div>
                <span *ngSwitchDefault class="value" [style.color]="card.color">{{ card.value }}</span>
              </ng-container>
            </div>
            <div class="card-footer-info">
              <p>{{ card.info }}</p>
            </div>
          </div>
        </div>
    </section>

    <!-- 3. Study Time Tracking Card -->
    <section class="time-tracking-card">
      <div class="time-tracking-header">
        <h3>Daily Study Tracking</h3>
        <button aria-label="More options"><i class="fas fa-ellipsis-h"></i></button>
      </div>
      <div class="timer-wrapper">
        <svg class="timer-svg" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
          <circle class="bg" cx="60" cy="60" r="54" />
          <circle class="fg" cx="60" cy="60" r="54" [attr.stroke-dasharray]="studyTimeStrokeDasharray" [attr.stroke-dashoffset]="studyTimeStrokeDashoffset" stroke-linecap="round" transform="rotate(-90 60 60)"></circle>
        </svg>
        <div class="timer-center">
          <div class="time">{{ studyTimeTimer }}</div>
          <div class="timer-controls-buttons">
            <button id="startBtn" aria-label="Start Study Session" (click)="startStudySession()" [disabled]="isStudying" title="Start Study Session">
              <i class="fas fa-play"></i>
            </button>
            <button id="stopBtn" aria-label="End Study Session" (click)="endStudySession()" [disabled]="!isStudying" title="End Study Session">
              <i class="fas fa-pause"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="time-info">
        <div class="time-info-item">
          <p class="label">Total Study Hours</p>
          <p class="value">{{ totalStudyHours }}</p>
        </div>
        <div class="time-info-item">
          <p class="label">Remaining Target</p>
          <p class="value">{{ targetRemainingHours }}</p>
        </div>
      </div>
      <div class="time-details" style="display: flex; justify-content: space-around; font-size: 12px; margin-top: 20px;">
        <p>Target: {{ MAX_TARGET_HOURS }}:00 hrs</p>
        <p style="color: #10b981;">Productivity Score: 88%</p>
      </div>
    </section>

    <!-- 4. Top 3 Courses/Progress Card -->
    <section class="next-holidays-card">
      <div class="next-holidays-header">
        <h3>Top Courses Progress</h3>
        <button aria-label="View All Courses"><i class="fas fa-chevron-right"></i></button>
      </div>
      <div class="holiday-list">
        <div class="holiday-item" *ngFor="let course of courses | slice:0:3">
          <!-- Using icon for course category -->
          <div class="course-icon" [style.background-color]="course.colorClass">
            <i [ngClass]="{'fas fa-terminal': course.category === 'CS', 'fas fa-server': course.category === 'IT', 'fas fa-graduation-cap': true}" style="color: white; font-size: 1.5rem;"></i>
          </div>
          <div class="holiday-info">
            <!-- Progress percentage is displayed with the title -->
            <p class="title">{{ course.title }} <span style="color: #4338CA; font-weight: 700;">({{ course.progress }}%)</span></p>
            <p class="date">Instructor: {{ course.instructor }}</p>
            <div class="progress-bar-small">
                <div class="fill" [style.width.%]="course.progress" [style.background-color]="getProgressColor(course.progress)"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 5. Latest Resources/Video Card -->
    <section class="video-card">
      <!-- Placeholder image with overlay for a tech resource video -->
      <ng-container>
        <img src="https://placehold.co/600x300/1f2937/10b981?text=Latest+Tech+Tutorial" alt="Latest Resource Tutorial" />
        <div class="video-overlay">
          <p class="title">Latest Resource: Cloud Deployment</p>
          <p class="subtitle">Quick tutorial on AWS deployment using Docker.</p>
          <button aria-label="Watch Now"><i class="fas fa-play"></i></button>
          <span class="duration">12 min</span>
        </div>
      </ng-container>
    </section>
  </ng-container>

  <!-- 2. ATTEND EXAM CONTENT (NEW PAGE) -->
  <ng-container *ngIf="activePage === 'attend-exam' && examToAttend">
      <app-attend-exam
          [examId]="examToAttend.examId"
          [examName]="examToAttend.examName"
          [durationMinutes]="examToAttend.durationMinutes"
          (examFinished)="onExamFinished($event)">
      </app-attend-exam>
  </ng-container>


  <!-- 3. PROFILE SETTING CONTENT -->
  <ng-container *ngIf="activePage === 'profile-setting'">
    <div class="profile-setting-wrapper">
      <app-profile-setting [profileData]="studentProfileData" (goBack)="setActivePage('dashboard')"></app-profile-setting>
    </div>
  </ng-container>

  <!-- 4. OTHER PAGES CONTENT (Placeholder) -->
  <ng-container *ngIf="activePage !== 'dashboard' && activePage !== 'profile-setting' && activePage !== 'attend-exam'">
    <div class="other-page-content">
      <h1>{{ activePage | uppercase }} Page Content (Not Implemented)</h1>
      <p>Please navigate back to the dashboard to see the main content.</p>
    </div>
  </ng-container>
</main>

<!-- Assignment Submission Modal -->
<div *ngIf="showAssignmentModal" class="assignment-modal-overlay">
<!-- ... (Assignment Modal Content remains the same) -->
  <div class="assignment-modal-content">
    <div class="modal-header">
      <h3>Submit Assignment</h3>
      <button class="close-button" (click)="closeAssignmentModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="assignmentTitle">Assignment Title:</label>
        <select id="assignmentTitle" [formControl]="assignmentTitleControl" required>
          <option value="">Select Assignment</option>
          <option value="CS501 - Final Project">CS501 - Final Project</option>
          <option value="IT402 - Week 8 Quiz">IT402 - Week 8 Quiz</option>
          <option value="IT303 - DB Schema">IT303 - DB Schema</option>
        </select>
      </div>
      <div class="form-group">
        <label for="submissionDetails">Submission Details/Link (Optional):</label>
        <textarea id="submissionDetails" [formControl]="assignmentDetailsControl" rows="4"></textarea>
      </div>
      <div class="form-group file-upload">
        <label>Upload File:</label>
        <input type="file" />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeAssignmentModal()">Cancel</button>
      <button class="btn-submit" (click)="submitAssignment()" [disabled]="assignmentTitleControl.invalid">Submit Work</button>
    </div>
  </div>
</div>

<!-- ======================================================= -->
<!-- EXAM ATTENDANCE MODAL -->
<!-- ======================================================= -->
<div *ngIf="showExamModal" class="assignment-modal-overlay">
    <div class="assignment-modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <!-- FIX: Batch ID और Course ID अब real-time 'studentProfileData' से आएगा (fallback to 'Unknown' if undefined) -->
            <h3>Attend Exam (Batch ID: {{ studentProfileData.batchId || 'Unknown' }}, Course ID: {{ studentProfileData.courseId || 'Unknown' }})</h3>
            <button class="close-button" (click)="closeExamModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Loading State -->
            <div *ngIf="isLoadingExams" style="text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #4338CA;"></i>
                <p style="margin-top: 10px; color: #64748B;">Loading available Exams...</p>
            </div>
            
            <!-- No Exams Available State -->
            <div *ngIf="!isLoadingExams && activeExams.length === 0" style="text-align: center; padding: 20px; border: 1px dashed #F43F5E; border-radius: 8px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 20px; color: #F43F5E;"></i>
                <p style="margin-top: 10px; font-weight: 600; color: #334155;">
                    Sorry! No active Exam found for your Batch (ID: {{ studentProfileData.batchId || 'Unknown' }}) and Course (ID: {{ studentProfileData.courseId || 'Unknown' }}).
                </p>
                <p style="font-size: 12px; color: #64748B; margin-top: 5px;">Please contact the administrator or check back later.</p>
            </div>

            <!-- Exam List and Selection -->
            <div *ngIf="!isLoadingExams && activeExams.length > 0">
                <p style="margin-bottom: 15px; font-size: 14px; color: #334155;">Select an Exam to start ({{ activeExams.length }} available):</p>

                <div class="form-group">
                    <label for="selectExam">Available Exams:</label>
                    <select id="selectExam" [(ngModel)]="selectedExamId" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #CBD5E1; border-radius: 4px;">
                        <option [ngValue]="null">--- Select Exam ---</option>
                        <option *ngFor="let exam of activeExams" [ngValue]="exam.examId">
                            <!-- FIX: batchName और subjectName के लिए fallback strings का उपयोग करें (जैसा कि TS में सेट किया गया है) -->
                            {{ exam.examName }} ({{ exam.subject.subjectname || ('Sub ID: ' + exam.subjectid) }} - {{ exam.durationMinutes }} Minutes)
                        </option>
                    </select>
                </div>
                
                <!-- Exam Details (Conditional Display) -->
                <div *ngIf="selectedExam" style="background-color: #f0f4ff; border: 1px solid #4338CA; border-radius: 8px; padding: 15px; margin-top: 20px;">
                    <ng-container *ngIf="selectedExam as currentExam">
                        <h4 style="font-size: 16px; margin-top: 0; color: #4338CA;">Exam Details</h4>
                        <p style="margin: 5px 0; font-size: 14px;"><i class="fas fa-book" style="margin-right: 8px; color: #4338CA;"></i> <strong>Subject:</strong> {{ currentExam.subject.subjectname || ('ID: ' + currentExam.subjectid) }}</p>
                        <p style="margin: 5px 0; font-size: 14px;"><i class="fas fa-clock" style="margin-right: 8px; color: #4338CA;"></i> <strong>Duration:</strong> {{ currentExam.durationMinutes }} Minutes</p>
                        <p style="margin: 5px 0; font-size: 14px;"><i class="fas fa-question-circle" style="margin-right: 8px; color: #4338CA;"></i> <strong>Total Questions:</strong> {{ currentExam.totalQuestions }}</p>
                        <p style="margin: 5px 0; font-size: 14px;"><i class="fas fa-users" style="margin-right: 8px; color: #4338CA;"></i> <strong>Target:</strong> Batch ID {{ currentExam.batchid }}, Course ID {{ currentExam.courseid }}</p>
                        
                        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #c0c7e2;">
                            <p style="margin: 5px 0; font-size: 14px; color: #22C55E;"><i class="fas fa-calendar-alt" style="margin-right: 8px;"></i> <strong>Start Time:</strong> {{ currentExam.start_datetime | date:'medium' }}</p>
                            <p style="margin: 5px 0; font-size: 14px; color: #EF4444;"><i class="fas fa-calendar-times" style="margin-right: 8px;"></i> <strong>End Time:</strong> {{ currentExam.end_datetime | date:'medium' }}</p>
                        </div>
                        
                        <p style="margin-top: 15px; font-size: 12px; color: #F43F5E;">**Warning:** Once the exam starts, you cannot stop or pause it.</p>
                    </ng-container>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" (click)="closeExamModal()">Cancel</button>
            <button class="btn-submit" 
                    (click)="startExam()" 
                    [disabled]="!selectedExamId || isLoadingExams"
                    style="background-color: #10B981;">
                <i class="fas fa-play" style="margin-right: 5px;"></i> Start Exam
            </button>
        </div>
    </div>
</div>
<div *ngIf="message" [class]="'message-box ' + messageType">
  {{ message }}
  <button class="close-message" (click)="clearMessage()">&times;</button>
</div>
</div>
</body>

<!-- FIX: New CSS to adjust main-content when the schedule card is hidden -->
<style>
/* Existing student-dashboard.component.css is loaded via styleUrls. 
   Adding temporary inline style for the main content adjustment. */
.main-content.full-width {
    width: 1160px; /* 800px + 350px (Schedule Card Width) - 20px (gap) = 1130px. Using a safe width */
    max-width: 100%;
    left: 180px;
    right: 34px;
    padding-right: 34px;
}

@media (max-width: 1200px) {
    /* Mobile/Tablet layout already stacks content, so no need for 'full-width' adjustment */
    .main-content.full-width {
        width: auto;
        left: auto;
        right: auto;
    }
}
</style>