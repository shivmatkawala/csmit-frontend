<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<body>
  <!-- Main container -->
  <div class="container" [class.exam-active-mode]="activePage === 'attend-exam'">
    
    <!-- HEADER SECTION -->
    <header *ngIf="activePage !== 'attend-exam'">
      <div class="logo-search">
        <div class="logo">
          <img src="assets/logo.jpg" alt="Logo" class="institute-logo">
        </div>
        <div class="search-wrapper">
          <input type="search" placeholder="Search Courses, Assignments..." [formControl]="searchControl" />
          <i class="fas fa-search"></i>
        </div>
      </div>
      <div class="header-right">
        <button class="btn-request" (click)="goToProfileSetupForm()" style="background-color: #F43F5E;">
          <i class="fas fa-user-edit"></i> <span>Setup Profile</span>
        </button>
      </div>
    </header>

    <!-- DASHBOARD GRID -->
    <div class="dashboard-grid" *ngIf="activePage !== 'attend-exam'">

      <!-- LEFT SIDEBAR -->
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <a [class.active]="activePage === 'dashboard'" (click)="setActivePage('dashboard')">
              <i class="fas fa-home"></i> <span>Home</span>
          </a>
          <a [class.active]="activePage === 'batches'" (click)="setActivePage('batches')">
              <i class="fas fa-book-reader"></i> <span>My Batches</span>
          </a>
          <a [class.active]="activePage === 'shorts'" (click)="setActivePage('shorts')" style="color: #ec4899;">
              <i class="fas fa-play-circle" style="font-size: 26px;"></i> <span>Shorts</span>
          </a>
          <a [class.active]="activePage === 'generate-resume'" (click)="goToResumeView()">
              <i class="fas fa-file-alt"></i> <span>Resume</span>
          </a>
          <a [class.active]="activePage === 'syntaxshare'" (click)="setActivePage('syntaxshare')">
              <i class="fas fa-comments"></i> <span>Doubt Hub</span>
          </a>
          <a (click)="logout()" style="color: #ef4444;">
              <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
          </a>
        </nav>
        <div class="sidebar-bottom">
          <div class="toggle-switch" [class.active]="notificationsEnabled" (click)="notificationsEnabled = !notificationsEnabled">
            <span></span>
          </div>
        </div>
      </aside>

      <!-- CENTER CONTENT -->
      <main class="main-content">
        <ng-container *ngIf="activePage === 'dashboard'">
          <!-- PROFILE CARD -->
          <section class="premium-profile-card">
              <div class="card-bg-decoration">
                  <div class="circle circle-1"></div>
                  <div class="circle circle-2"></div>
              </div>
              <div class="profile-content-wrapper">
                <div class="profile-upload-container" (click)="triggerProfileUpload()">
                    <div class="premium-profile-ring">
                        <div class="attractive-profile-circle" 
                             [style.backgroundColor]="uploadedProfileImage ? 'transparent' : '#ffffff20'">
                            <img *ngIf="uploadedProfileImage" [src]="uploadedProfileImage" alt="Profile" class="uploaded-profile-img">
                            <span *ngIf="!uploadedProfileImage" class="profile-initial-text">{{ profileInitial }}</span>
                            <div class="camera-icon-overlay"><i class="fas fa-camera"></i></div>
                        </div>
                    </div>
                    <input type="file" #fileInput (change)="onProfileImageSelected($event)" accept="image/*" style="display: none;">
                </div>
                <div class="profile-text-content">
                    <span class="status-badge"><i class="fas fa-star"></i>Student</span>
                    <h2 class="student-name-text">{{ studentName }}</h2> 
                    <p class="greeting-message">{{ greeting }}</p>
                    <div class="date-badge">
                        <i class="far fa-calendar-alt"></i>
                        <span>{{ currentDayOfWeek }}, {{ currentDay }} {{ currentMonth }}</span>
                    </div>
                </div>
              </div>
          </section>

          <!-- STAT CARDS -->
          <section class="stats-cards-container">
              <div *ngFor="let card of quickAccessCards; let i = index" 
                  class="stat-card" 
                  [ngClass]="card.colorClass"
                  (click)="handleQuickCardClick(card.route)">
                <p class="title">{{ card.title }}</p>
                <!-- Display logic for batches -->
                <p class="value" *ngIf="card.route === 'batches'">{{ studentAssignedBatches.length > 0 ? studentAssignedBatches[0].batch_name : 'No Batch' }}</p>
                <p class="value" *ngIf="card.route !== 'batches'">{{ card.value }}</p>
                <div class="footer-info">
                  <span>{{ card.subText }}</span>
                  <i [class]="card.icon" [ngStyle]="{'color': card.color}"></i>
                </div>
              </div>
          </section>
        </ng-container>

        <!-- Pages Integration -->
        <ng-container *ngIf="activePage === 'batches'">
          <!-- COMPILATION FIX: Using userId property matched with updated component logic -->
          <app-course-batch-management 
            [userId]="studentProfileData.student_id" 
            [initialBatches]="studentAssignedBatches"
            (backToDashboard)="setActivePage('dashboard')">
          </app-course-batch-management>
        </ng-container>

        <ng-container *ngIf="activePage === 'shorts'">
            <div class="shorts-wrapper">
                <div class="shorts-container">
                    <div class="short-item" *ngFor="let short of shortsList">
                        <div class="video-container">
                            <iframe [src]="short.safeUrl" frameborder="0" allowfullscreen></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </ng-container>

        <ng-container *ngIf="activePage === 'generate-resume'">
            <app-generate-ats-resume [isDashboardEmbed]="true"></app-generate-ats-resume>
        </ng-container>

        <ng-container *ngIf="activePage === 'syntaxshare'">
            <app-syntaxshare></app-syntaxshare>
        </ng-container>
      </main>

      <!-- RIGHT SIDEBAR (SCHEDULE) -->
      <section class="right-schedule-card">
        <div class="current-time-display">
          <p class="current-time-text">Current Time: {{ currentTime }}</p>
        </div>
        <div class="right-schedule-header">
          <h3>My Schedule</h3>
          <button (click)="openExamModal()" style="color: #F59E0B; font-size: 16px;">
              <i class="fas fa-edit"></i> Exams
          </button>
        </div>
        <div class="calendar-controls">
          <button (click)="navigateCalendar(-1)">&lt;</button>
          <p>{{ selectedMonthYear }}</p>
          <button (click)="navigateCalendar(1)">&gt;</button>
        </div>
        <div class="calendar-weekdays">
          <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
        </div>
        <div class="calendar-days">
          <div *ngFor="let day of calendarDays"
            [class.inactive]="day.disabled"
            [class.active]="day.selected"
            (click)="!day.disabled && onDateSelect(day.fullDate)">
            {{ day.date }}
          </div>
        </div>
        <div class="schedule-list">
          <h5>Schedule for {{ selectedScheduleDate | date:'dd MMM' }}</h5>
          <div *ngIf="scheduleDetails.length === 0" class="no-schedule-message">No classes today.</div>
          <div *ngFor="let item of scheduleDetails" class="schedule-section">
            <div class="schedule-item" [ngClass]="item.type + '-item'">
              <div class="date">{{ item.dayOfWeekShort }} <br> {{ item.dayOfMonth }}</div>
              <p class="desc">{{ item.desc }}</p>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- ATTEND EXAM -->
    <ng-container *ngIf="activePage === 'attend-exam'">
        <app-attend-exam 
            [examId]="examToAttend?.examId || null" 
            [durationMinutes]="examToAttend?.durationMinutes || 60"
            [examName]="examToAttend?.examName || 'Assessment'"
            (examFinished)="onExamFinished($event)">
        </app-attend-exam>
    </ng-container>

    <!-- EXAM MODAL -->
    <div *ngIf="showExamModal" class="modal-overlay exam-lobby-overlay">
        <div class="modal-content premium-exam-modal">
            <button class="modal-close-btn" (click)="closeExamModal()"><i class="fas fa-times"></i></button>
            <div class="exam-modal-header">
                <div class="header-icon"><i class="fas fa-file-signature"></i></div>
                <div class="header-titles">
                    <h3>Assessment Center</h3>
                    <p>Select an active examination to begin.</p>
                </div>
            </div>
            <div class="modal-body exam-list-container">
                <div *ngIf="!isLoadingExams && upcomingExams.length > 0" class="exam-grid">
                    <div *ngFor="let exam of upcomingExams" class="exam-entry-card" (click)="selectedExamId = exam.examId" [class.selected]="selectedExamId === exam.examId">
                        <div class="exam-status-dot active"></div>
                        <div class="exam-main-info">
                            <span class="exam-subject-tag">{{ exam.subject.subjectname }}</span>
                            <h4>{{ exam.examName }}</h4>
                            <div class="exam-meta-row">
                                <span><i class="far fa-clock"></i> {{ exam.durationMinutes }} Min</span>
                                <span class="dot"></span>
                                <span><i class="fas fa-list-ol"></i> {{ exam.totalQuestions }} Qs</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer exam-modal-footer">
                <button class="btn-secondary-outline" (click)="closeExamModal()">Cancel</button>
                <button class="btn-primary-gradient" [disabled]="!selectedExamId" (click)="startExam()">Start Exam</button>
            </div>
        </div>
    </div>

    <!-- JOIN MEETING MODAL (NEW) -->
    <div *ngIf="showJoinMeetingModal" class="modal-overlay exam-lobby-overlay">
        <div class="modal-content premium-exam-modal" style="max-width: 500px;">
            <button class="modal-close-btn" (click)="closeJoinMeetingModal()"><i class="fas fa-times"></i></button>
            <div class="exam-modal-header">
                <div class="header-icon" style="background: #10B981;"><i class="fas fa-video"></i></div>
                <div class="header-titles">
                    <h3>Join Live Class</h3>
                    <p>Select your batch to attend the session.</p>
                </div>
            </div>
            <div class="modal-body exam-list-container" style="max-height: 350px;">
                <div *ngIf="selectedBatchDetails.length === 0" class="no-exams-placeholder">
                    <p>Syncing batch details...</p>
                </div>
                <div class="exam-grid" *ngIf="selectedBatchDetails.length > 0">
                    <div *ngFor="let batch of selectedBatchDetails" class="exam-entry-card" style="cursor: default; border-color: #e2e8f0;">
                        <div class="exam-main-info">
                            <span class="exam-subject-tag">{{ batch.mode || 'Online' }}</span>
                            <h4>{{ batch.batchName }}</h4>
                            <p style="font-size: 12px; color: #64748b;">{{ batch.timing || 'No timing set' }}</p>
                        </div>
                        <button class="btn-primary-gradient" 
                                style="padding: 8px 16px; font-size: 12px; background: #10B981;"
                                (click)="joinMeeting(batch.zoom_join_url)">
                            Join Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

  </div>
  <div *ngIf="message" [class]="'message-box ' + messageType">{{ message }}</div>
</body>