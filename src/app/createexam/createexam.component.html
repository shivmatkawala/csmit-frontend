<div class="create-exam-container">
  <h2>Create Exam</h2>

  <!-- Custom Message Box -->
  <div *ngIf="message" class="info-box" [ngClass]="{'error-box': message.type === 'error', 'success-box': message.type === 'success'}">
    <p>{{ message.text }}</p>
  </div>
  
  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="info-box loading-box">
    <p>Loading data, please wait...</p>
  </div>
  
  <!-- STEP 1: Exam Metadata Form -->
  <ng-container *ngIf="step === 1">
    <h3>Step 1: Exam Details</h3>
    <form #metadataForm="ngForm" (ngSubmit)="onProceed(metadataForm)">
      
      <!-- Exam Name -->
      <div class="form-group">
        <label for="examName">Exam Name</label>
        <input
          id="examName"
          type="text"
          name="examName"
          [(ngModel)]="examMetadata.examName"
          required
          placeholder="e.g., DevOps Fundamentals Test"
        />
      </div>

      <!-- Course ID -->
      <div class="form-group">
        <label for="courseId">Course</label>
        <select
          id="courseId"
          name="courseid"
          [(ngModel)]="examMetadata.courseid" 
          (change)="onCourseSelect()"
          required
        >
          <option [ngValue]="null" disabled>Select Course</option>
          <option *ngFor="let course of courses" [ngValue]="course.courseid">
            {{ course.coursename }} (ID: {{ course.courseid }})
          </option>
        </select>
        <div *ngIf="courses.length === 0 && !isLoading" class="info-box" style="margin-top: 5px; border-left-color: #f1c40f;">
            <p>Courses not loaded. Check API or add data.</p>
        </div>
      </div>

      <!-- Batch ID -->
      <div class="form-group">
        <label for="batchId">Batch</label>
        <select
          id="batchId"
          name="batchId"
          [(ngModel)]="examMetadata.batchId"
          required
          [disabled]="!examMetadata.courseid || batches.length === 0" 
        >
          <option [ngValue]="null" disabled>Select Batch</option>
          <!-- Batch Name dikhana -->
          <option *ngFor="let batch of batches" [ngValue]="batch.batchId">
            {{ batch.name }} (ID: {{ batch.batchId }})
          </option>
        </select>
        <div *ngIf="examMetadata.courseid && batches.length === 0 && !isLoading" class="info-box" style="margin-top: 5px;">
            <p>No batches found for the selected course.</p>
        </div>
      </div>
      
      <!-- Subject ID -->
      <div class="form-group">
        <label for="subjectId">Subject</label>
        <select
          id="subjectId"
          name="subjectId"
          [(ngModel)]="examMetadata.subjectId"
          required
          [disabled]="!examMetadata.courseid || subjects.length === 0" 
        >
          <option [ngValue]="null" disabled>Select Subject</option>
          <!-- FIX: subject.subjectName ko subject.subjectname se badla, aur subjectId ‡§ï‡•ã subject.subjectid ‡§∏‡•á ‡§¨‡§æ‡§Ç‡§ß‡§æ -->
          <option *ngFor="let subject of subjects" [ngValue]="subject.subjectid">
            {{ subject.subjectname }} (ID: {{ subject.subjectid }})
          </option>
        </select>
        <div *ngIf="examMetadata.courseid && subjects.length === 0 && !isLoading" class="info-box" style="margin-top: 5px;">
            <p>No subjects found for the selected course.</p>
        </div>
      </div>

      <!-- Start Date/Time -->
      <div class="form-group">
        <label for="start">Start Time</label>
        <input
          id="start"
          type="datetime-local"
          name="start"
          [(ngModel)]="examMetadata.start"
          required
        />
      </div>
      
      <!-- End Date/Time -->
      <div class="form-group">
        <label for="end">End Time</label>
        <input
          id="end"
          type="datetime-local"
          name="end"
          [(ngModel)]="examMetadata.end"
          required
        />
      </div>

      <div class="btn-group">
        <button type="submit" class="primary-btn" [disabled]="metadataForm.invalid || isLoading">
          Proceed to Questions
        </button>
      </div>
    </form>
  </ng-container>

  <!-- STEP 2: Questions Form -->
  <ng-container *ngIf="step === 2">
    <h3>Step 2: Define Questions (Exam: {{ examMetadata.examName }})</h3>
    <form #examForm="ngForm" (ngSubmit)="onSubmit(examForm)">
      
      <div *ngFor="let q of questions; let i = index; trackBy: trackByIndex" class="question-card">
        <h3>Question {{ i + 1 }}</h3>

        <!-- Question text -->
        <div class="form-group">
          <label>Question</label>
          <textarea
            name="questionText_{{i}}"
            [(ngModel)]="q.questionText"
            required
            placeholder="Enter question text..."
          ></textarea>
        </div>

        <!-- Question type -->
        <div class="form-group">
          <label>Question Type</label>
          <select
            name="questionType_{{i}}"
            [(ngModel)]="q.questionType"
            required
          >
            <option value="">Select Type</option>
            <option *ngFor="let type of questionTypes" [value]="type">
              {{ type | titlecase }}
            </option>
          </select>
        </div>

        <!-- MCQ options -->
        <div *ngIf="q.questionType === 'mcq'" class="form-group mcq-section">
          <h4>Options</h4>
          <div *ngFor="let opt of q.options; let j = index; trackBy: trackByIndex" class="option-row">
            <label>Option {{ j + 1 }}</label>
            <input
              type="text"
              name="option_{{i}}_{{j}}"
              [(ngModel)]="q.options[j]"
              required
              placeholder="Enter option {{ j + 1 }}"
            />
          </div>

          <div class="form-group">
            <label>Correct Option</label>
            <select
              name="correctOption_{{i}}"
              [(ngModel)]="q.correctOption"
              required
            >
              <option [ngValue]="null" disabled>Select Correct Option</option>
              <!-- FIX: value ‡§ï‡•ã option text ‡§ï‡•á ‡§¨‡§ú‡§æ‡§Ø index (number) ‡§™‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç -->
              <option *ngFor="let opt of q.options; let j = index; trackBy: trackByIndex" [ngValue]="j">
                Option {{ j + 1 }} ({{ opt }})
              </option>
            </select>
          </div>
        </div>

        <!-- Descriptive -->
        <div *ngIf="q.questionType === 'discriptive'" class="info-box">
          <p>Descriptive questions do not require options.</p>
        </div>

        <!-- Coding -->
        <div *ngIf="q.questionType === 'coding'" class="info-box">
          <p>Coding questions do not require options.</p>
        </div>

        <!-- Points -->
        <div class="form-group">
          <label>Points</label>
          <input
            type="number"
            name="points_{{i}}"
            [(ngModel)]="q.points"
            required
            min="1"
            placeholder="Enter points"
          />
        </div>

        <hr *ngIf="i < questions.length - 1" />
      </div>

      <div class="btn-group">
        <button type="button" (click)="onBack()" class="secondary-btn">‚Üê Back to Details</button>
        <button type="button" (click)="addMore()" class="secondary-btn">+ Add More Question</button>
        <button type="submit" [disabled]="!examForm.valid || isLoading" class="primary-btn">üíæ Create Exam</button>
      </div>
    </form>
  </ng-container>
</div>